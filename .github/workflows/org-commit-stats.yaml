name: Org Commit Insights (Markdown + Pages)

on:
  workflow_dispatch:
    inputs:
      weeks:
        description: "Weeks to aggregate (4 ~= 28 days, 5 ~= 35 days)"
        required: false
        default: "24"
  schedule:
    - cron: "0 6 * * 1" # every Monday 06:00 UTC

env:
  ORG_NAME: Ludo-MVP

permissions:
  contents: write

concurrency:
  group: org-commit-insights
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify gh is available
        run: gh --version

      - name: Generate Markdown report (all branches)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          ORG="${ORG_NAME}"
          WEEKS="${{ inputs.weeks || '5' }}"
          OUT="docs/insights/commits.md"

          mkdir -p docs/insights

          mapfile -t REPOS < <(
            gh api "orgs/${ORG}/repos?per_page=100" --paginate \
            --jq '.[] | select(.fork==false and .archived==false) | .full_name'
          )

          total=0
          processed=0
          skipped=0

          {
            echo "# Organization Commit Insights"
            echo
            echo "**Org:** ${ORG}  "
            echo "**Period:** last ${WEEKS} weeks (all branches)  "
            echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M UTC")"
            echo
            echo "## Summary"
            echo "- **Total commits:** (computing...)"
            echo "- **Repositories counted:** (computing...)"
            echo "- **Repositories skipped:** (computing...)"
            echo
            echo "## Commits by repository"
            echo "| Repository | Commits |"
            echo "|-----------|--------:|"
          } > "$OUT"

          for repo in "${REPOS[@]}"; do
            data=""

            for _ in {1..8}; do
              resp="$(gh api -i "repos/${repo}/stats/commit_activity" 2>/dev/null || true)"
              status="$(printf "%s" "$resp" | head -n1 | a
