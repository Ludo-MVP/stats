name: Org Commit Insights (last 30 days, per repo, Markdown)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # every Monday 06:00 UTC

env:
  ORG_NAME: Ludo-MVP

permissions:
  contents: write

concurrency:
  group: org-commit-insights
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # GitHub-hosted runners already have gh installed
      - name: Verify gh is available
        run: gh --version

      # Requires secrets:
      # - GH_APP_ID
      # - GH_APP_PRIVATE_KEY  (full PEM content)
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ env.ORG_NAME }}

      - name: Generate Markdown report (last 30 days)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        shell: bash
        run: |
          set -euo pipefail

          ORG="${ORG_NAME}"
          OUT="docs/insights/commits.md"
          SINCE="$(date -u -d '30 days ago' +%Y-%m-%d)"

          mkdir -p docs/insights

          # List all repos visible to the App token (includes private)
          mapfile -t REPOS < <(
            gh api "orgs/${ORG}/repos?per_page=100" --paginate \
              --jq '.[] | select(.fork==false and .archived==false) | .full_name'
          )

          total=0
          processed=0
          skipped=0

          {
            echo "# Organization Commit Insights"
            echo
            echo "**Org:** ${ORG}  "
            echo "**Period:** last 30 days (since ${SINCE}, all branches)  "
            echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M UTC")"
            echo
            echo "## Summary"
            echo "- **Total commits:** (computing...)"
            echo "- **Repositories counted:** (computing...)"
            echo "- **Repositories skipped:** (computing...)"
            echo
            echo "## Commits by repository"
            echo "| Repository | Commits |"
            echo "|-----------|--------:|"
          } > "${OUT}"

          # Helper: query Search Commits API for a single repo with retries
          # Note: REST Search is rate-limited (typically 30 req/min). We throttle.
          get_repo_commit_count() {
            local repo="$1"
            local since="$2"
            local tries=0
            local max_tries=6

            while (( tries < max_tries )); do
              tries=$((tries+1))

              # Request headers + body so we can detect rate limiting and status
              # Search commits requires this preview Accept header.
              local resp status body
              resp="$(gh api -i -H "Accept: application/vnd.github.cloak-preview+json" \
                "/search/commits?q=repo:${repo}+committer-date:>=${since}&per_page=1" 2>/dev/null || true)"

              status="$(printf "%s" "$resp" | head -n 1 | awk '{print $2}')"
              body="$(printf "%s" "$resp" | awk 'BEGIN{p=0} /^\r?$/{p=1;next} {if(p)print}')"

              if [[ "$status" == "200" ]]; then
                # total_count is what we need; per_page=1 keeps payload tiny
                echo "$body" | jq -r '.total_count // 0' 2>/dev/null || echo 0
                return 0
              fi

              # 403 can be rate limit; backoff and retry
              if [[ "$status" == "403" ]]; then
                sleep $((10 * tries))
                continue
              fi

              # 422/404/etc -> treat as skipped
              echo ""
              return 1
            done

            echo ""
            return 1
          }

          for repo in "${REPOS[@]}"; do
            # Throttle to stay under Search API limits
            # 2.2s => ~27 req/min, safe for 30 req/min
            sleep 2.2

            c="$(get_repo_commit_count "${repo}" "${SINCE}" || true)"

            if [[ -z "${c}" ]]; then
              skipped=$((skipped+1))
              continue
            fi

            # Ensure numeric
            if ! [[ "${c}" =~ ^[0-9]+$ ]]; then
              skipped=$((skipped+1))
              continue
            fi

            processed=$((processed+1))
            total=$((total + c))

            printf "| %s | %s |\n" "${repo}" "${c}" >> "${OUT}"
          done

          # Patch summary placeholders
          perl -0777 -i -pe \
            "s/- \\*\\*Total commits:\\*\\* \\(computing\\...\\)/- **Total commits:** ${total}/g;
             s/- \\*\\*Repositories counted:\\*\\* \\(computing\\...\\)/- **Repositories counted:** ${processed}/g;
             s/- \\*\\*Repositories skipped:\\*\\* \\(computing\\...\\)/- **Repositories skipped:** ${skipped}/g" \
            "${OUT}"

          echo "Report written to ${OUT}"
          head -n 40 "${OUT}"

      - name: Commit & push report
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add docs/insights/commits.md

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update org commit insights (last 30 days)"
          git push
